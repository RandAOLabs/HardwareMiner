# Story 1.2: Orange Pi WiFi Hotspot Creation

## Status
Draft

## Story
**As a** user with a new Orange Pi device,
**I want** the device to automatically create a discoverable WiFi hotspot,
**so that** my mobile app can find and connect to the device for initial setup.

## Acceptance Criteria
1. Orange Pi creates WiFi hotspot on startup with SSID pattern "RNG-Miner-XXXXXXXX" (XXXXXXXX is unique 8-character hardware-based device ID)
2. Hotspot uses hardcoded password: "RNG-Miner-Password-123"
3. Hotspot provides DHCP service for connecting devices (192.168.12.0/24 range, clients 192.168.12.100-200)
4. HTTP server is accessible via hotspot connection
5. Hotspot remains active until device successfully connects to home WiFi

## Tasks / Subtasks

- [ ] **Task 1: Install and configure hostapd** (AC: 1, 2)
  - [ ] Install hostapd package for WiFi access point functionality
  - [ ] Create hostapd configuration file with dynamic SSID generation
  - [ ] Configure WiFi interface (wlan0) for access point mode
  - [ ] Generate unique 8-character device ID from hardware identifiers (MAC address)
  - [ ] Set hardcoded password "RNG-Miner-Password-123" in configuration
  - [ ] Configure hostapd to start automatically on boot

- [ ] **Task 2: Configure DHCP server** (AC: 3)
  - [ ] Install and configure dnsmasq for DHCP functionality
  - [ ] Set DHCP range to 192.168.12.100-200 (confirmed standard)
  - [ ] Configure gateway and DNS settings (192.168.12.1)
  - [ ] Set lease time and other DHCP parameters
  - [ ] Ensure DHCP service starts with hotspot

- [ ] **Task 3: Network interface configuration** (AC: 3, 4)
  - [ ] Configure wlan0 static IP address (192.168.12.1/24)
  - [ ] Set up IP forwarding and NAT rules (if needed)
  - [ ] Configure network interface to work with both hotspot and client modes
  - [ ] Ensure HTTP server can bind to hotspot IP address
  - [ ] Test network connectivity between connected devices and HTTP server

- [ ] **Task 4: Hotspot lifecycle management** (AC: 5)
  - [ ] Create scripts to start/stop hotspot mode
  - [ ] Implement hotspot status monitoring
  - [ ] Create mechanism to disable hotspot when WiFi connection succeeds
  - [ ] Add hotspot restart capability for error recovery
  - [ ] Ensure clean transition between hotspot and WiFi client modes

- [ ] **Task 5: Device ID generation and persistence** (AC: 1)
  - [ ] Implement hardware-based device ID generation algorithm
  - [ ] Use MAC address and/or device serial number for uniqueness
  - [ ] Store device ID persistently across reboots
  - [ ] Validate device ID format (8 characters, alphanumeric)
  - [ ] Update device configuration with generated ID

- [ ] **Task 6: Integration with HTTP server** (AC: 4)
  - [ ] Verify HTTP server accessibility on hotspot IP (192.168.12.1:8080)
  - [ ] Update HTTP server configuration for hotspot interface
  - [ ] Test HTTPS certificate accessibility via hotspot connection
  - [ ] Ensure /health and /device/info endpoints work via hotspot
  - [ ] Add hotspot status to device info endpoint

- [ ] **Task 7: Set up unit and integration testing**
  - [ ] Create test file: `/opt/device-software/tests/test_wifi_hotspot.py`
  - [ ] Test device ID generation consistency and format
  - [ ] Test hostapd configuration generation and startup
  - [ ] Test DHCP service functionality and IP assignment
  - [ ] Test HTTP server accessibility via hotspot connection
  - [ ] Test hotspot lifecycle (start/stop/restart)

## Dev Notes

### Previous Story Context
[Source: Story 1.1]
- HTTP server is established on port 8080 with HTTPS/TLS
- Self-signed certificate generated on startup
- Device configuration stored in `/opt/device-software/config/device-config.json`
- Hardware-based device ID generation framework needed

### Tech Stack and Implementation Guidelines
[Source: architecture/tech-stack.md]
- **WiFi Hardware:** Orange Pi Zero 3 - 802.11ac dual-band (2.4GHz + 5GHz) with built-in antenna
- **Hotspot Software:** hostapd for WiFi access point functionality
- **DHCP Service:** dnsmasq for IP address assignment
- **Network Range:** 192.168.12.0/24 subnet for hotspot clients
- **SSID Pattern:** "RNG-Miner-XXXXXXXX" where XXXXXXXX is unique 8-character hardware ID

### File Locations and Project Structure
[Source: architecture/unified-project-structure.md]
```
/opt/device-software/
├── src/wifi-manager/             # WiFi hotspot management implementation
├── scripts/
│   ├── start-hotspot.sh         # Hotspot startup script
│   └── stop-hotspot.sh          # Hotspot shutdown script
├── config/
│   ├── hostapd.conf             # hostapd configuration file
│   ├── dnsmasq.conf             # DHCP server configuration
│   └── device-config.json       # Device configuration with generated ID
└── logs/wifi-manager.log        # WiFi management logs
```

### Configuration Requirements
[Source: architecture/coding-standards.md]
**hostapd Configuration Format:**
```
interface=wlan0
driver=nl80211
ssid=RNG-Miner-{DEVICE_ID}
hw_mode=g
channel=7
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=RNG-Miner-Password-123
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP
```

**dnsmasq Configuration:**
```
interface=wlan0
dhcp-range=192.168.12.100,192.168.12.200,255.255.255.0,24h
dhcp-option=3,192.168.12.1
dhcp-option=6,192.168.12.1
server=8.8.8.8
```

### Hardware ID Generation Algorithm
[Source: architecture/tech-stack.md, coding-standards.md]
```python
def generate_device_id():
    """Generate 8-character hardware-based device ID from unique hardware identifiers"""
    import hashlib
    import subprocess

    # Collect multiple hardware identifiers for uniqueness
    identifiers = []

    # Get MAC address of wlan0 interface
    try:
        mac_address = get_interface_mac('wlan0')
        identifiers.append(mac_address)
    except:
        pass

    # Get CPU serial number (if available)
    try:
        cpu_serial = subprocess.check_output(['cat', '/proc/cpuinfo']).decode().split('Serial')[1].split('\n')[0].strip()
        identifiers.append(cpu_serial)
    except:
        pass

    # Get machine ID
    try:
        machine_id = subprocess.check_output(['cat', '/etc/machine-id']).decode().strip()
        identifiers.append(machine_id)
    except:
        pass

    # Create hash from combined identifiers
    combined_id = '-'.join(identifiers)
    hash_input = f"RNG-MINER-{combined_id}".encode('utf-8')
    device_hash = hashlib.sha256(hash_input).hexdigest()

    # Take first 8 characters and convert to uppercase
    device_id = device_hash[:8].upper()

    return device_id
```

### Network Interface Configuration
[Source: architecture/unified-project-structure.md]
- **Hotspot IP:** 192.168.12.1/24 static assignment
- **DHCP Range:** 192.168.12.100-200 for client devices (standardized)
- **Gateway:** 192.168.12.1 (hotspot device)
- **DNS:** 192.168.12.1 (local) and 8.8.8.8 (fallback)

### Security and Access Control
[Source: architecture/coding-standards.md]
- **WPA2-PSK:** Use WPA2 encryption with pre-shared key
- **Password:** Hardcoded "RNG-Miner-Password-123" for V1.0
- **MAC Filtering:** Disabled (macaddr_acl=0) for ease of connection
- **Network Isolation:** Consider client isolation for security

### Integration Points
- **HTTP Server Integration:** Ensure server binds to hotspot IP (192.168.12.1)
- **Certificate Access:** HTTPS certificate must be accessible via hotspot connection at 192.168.12.1:8080
- **WiFi State Machine:** Hotspot lifecycle managed by state machine (Story 1.6)
- **Device Discovery:** Mobile app will scan for "RNG-Miner-*" SSID pattern

### Error Handling and Recovery
[Source: architecture/coding-standards.md]
- Log all hotspot operations to `/opt/device-software/logs/wifi-manager.log`
- Implement retry mechanism for hotspot startup failures
- Handle interface conflicts between hotspot and client modes
- Provide manual hotspot restart capability
- Monitor hotspot status and client connections

### Performance and Resource Considerations
- Hotspot should support at least 5 concurrent client connections
- Monitor CPU and memory usage during hotspot operation
- Implement connection timeout for idle clients
- Consider power management for extended hotspot operation

## Testing

### Unit Testing Requirements
[Source: architecture/testing-strategy.md]
- **Test File Location:** `/opt/device-software/tests/test_wifi_hotspot.py`
- **Testing Framework:** Python unittest or pytest
- **Coverage Requirements:** 80% minimum for critical hotspot functionality
- **Test Categories:**
  - Device ID generation and persistence
  - hostapd configuration file generation
  - DHCP configuration and service management
  - Network interface configuration
  - Hotspot lifecycle management

### Integration Testing Requirements
[Source: architecture/testing-strategy.md]
- **Physical WiFi Testing:** Test hotspot creation on actual Orange Pi hardware
- **Client Connection Testing:** Connect test devices to hotspot and verify DHCP assignment
- **HTTP Server Integration:** Verify HTTPS server accessibility via hotspot connection (192.168.12.1:8080)
- **Certificate Trust Testing:** Test certificate accessibility and trust workflow
- **Network Performance:** Test bandwidth and connection stability under load
- **Interface Switching:** Test transition between hotspot and WiFi client modes

### Test Data Requirements
- Mock MAC addresses for device ID generation testing
- Sample hostapd and dnsmasq configuration files
- Network interface configuration test scenarios
- Client device connection simulation data

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-15 | 1.0 | Initial story creation with hotspot setup requirements | Bob (Scrum Master) |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be populated here after implementation*